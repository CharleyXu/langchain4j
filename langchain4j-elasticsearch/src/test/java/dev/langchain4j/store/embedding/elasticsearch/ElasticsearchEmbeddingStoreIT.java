package dev.langchain4j.store.embedding.elasticsearch;

import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.model.embedding.AllMiniLmL6V2QuantizedEmbeddingModel;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.store.embedding.EmbeddingStore;
import dev.langchain4j.store.embedding.EmbeddingStoreWithFilteringIT;
import lombok.SneakyThrows;
import org.junit.jupiter.api.Test;

import static dev.langchain4j.internal.Utils.randomUUID;

class ElasticsearchEmbeddingStoreIT extends EmbeddingStoreWithFilteringIT {

    EmbeddingStore<TextSegment> embeddingStore = ElasticsearchEmbeddingStore.builder()
            .serverUrl("127.0.0.1:9200")
            .indexName(randomUUID())
            .dimension(768)
            .build();

    EmbeddingModel embeddingModel = new AllMiniLmL6V2QuantizedEmbeddingModel();

    @Override
    protected EmbeddingStore<TextSegment> embeddingStore() {
        return embeddingStore;
    }

    @Override
    protected EmbeddingModel embeddingModel() {
        return embeddingModel;
    }

    @Override
    protected void ensureStoreIsEmpty() {
        // TODO fix
    }

    @Override
    @SneakyThrows
    protected void awaitUntilPersisted() {
        Thread.sleep(1000);
    }

    @Test
    public void findTest() {
        double[] vectors = new double[]{
                -0.4093743860721588,
                -0.5599094033241272,
                -0.04735308885574341,
                0.025333620607852936,
                0.3093051016330719,
                0.14127427339553833,
                0.48462551832199097,
                -0.34208181500434875,
                -0.22342471778392792,
                -0.3415581285953522,
                0.13357408344745636,
                0.8603686094284058,
                -0.5968469381332397,
                -0.2974889278411865,
                0.20234008133411407,
                -0.04325959086418152,
                0.11815682053565979,
                -0.0012914342805743217,
                0.22483238577842712,
                -0.31815072894096375,
                0.2217210978269577,
                0.7645806074142456,
                -0.3126828968524933,
                0.5102106928825378,
                -0.18607068061828613,
                -0.30207717418670654,
                0.0779343768954277,
                0.2729717195034027,
                0.40076807141304016,
                0.2464325875043869,
                -0.13642020523548126,
                -0.1803833544254303,
                -0.15250685811042786,
                -0.18253307044506073,
                0.07955354452133179,
                0.10982432961463928,
                0.7381778359413147,
                0.18246051669120789,
                0.42389729619026184,
                -0.11829919368028641,
                0.24600814282894135,
                0.36192676424980164,
                0.41536325216293335,
                0.41642534732818604,
                0.42072221636772156,
                -0.08821836113929749,
                0.33589980006217957,
                0.06772401183843613,
                -0.22230049967765808,
                0.14675851166248322,
                -0.3060823380947113,
                2.9173548221588135,
                0.4217565059661865,
                -0.152118518948555,
                -0.24061386287212372,
                0.9117485880851746,
                0.21252445876598358,
                0.4388223886489868,
                0.633927047252655,
                0.005863734055310488,
                0.5558735728263855,
                -0.013553239405155182,
                -0.6510657072067261,
                0.5980557799339294,
                0.6908186078071594,
                -0.02866940200328827,
                0.018916869536042213,
                0.395925909280777,
                0.08130094408988953,
                -0.8949043154716492,
                0.7581784725189209,
                0.2891489565372467,
                0.4405089020729065,
                -0.6352747082710266,
                0.003815713571384549,
                0.3425229787826538,
                -0.4065449833869934,
                -0.04519503191113472,
                -0.029899289831519127,
                -0.09328359365463257,
                0.1772712916135788,
                -0.033662352710962296,
                -0.052085332572460175,
                -1.3231436014175415,
                0.6229547262191772,
                -0.1413908749818802,
                -0.4297415018081665,
                0.030708884820342064,
                1.360945701599121,
                0.02824956551194191,
                -0.1787330061197281,
                0.46586623787879944,
                -0.06673172116279602,
                0.24705585837364197,
                -0.47410598397254944,
                -0.2090231478214264,
                0.4270637333393097,
                0.38696524500846863,
                0.11970188468694687,
                -0.48578619956970215,
                -0.08964965492486954,
                -0.2284213900566101,
                0.2818252146244049,
                -0.6458199620246887,
                0.7372884750366211,
                0.5887181758880615,
                0.42377060651779175,
                0.4316847324371338,
                -0.3763754069805145,
                0.452842116355896,
                0.2250843346118927,
                0.01010067481547594,
                -0.3535598814487457,
                -0.3748115599155426,
                0.007453497964888811,
                -0.10992943495512009,
                -0.2140590250492096,
                -0.023373471572995186,
                0.2440636307001114,
                -0.4789450764656067,
                0.2579653561115265,
                -0.034798137843608856,
                -0.44737258553504944,
                0.10488761216402054,
                -0.12296237796545029,
                -0.12960229814052582,
                0.15557801723480225,
                0.23736529052257538,
                0.11418324708938599,
                -0.24547214806079865,
                -0.19591349363327026,
                -0.06831131875514984,
                -0.16500474512577057,
                -0.3634677529335022,
                0.7483810186386108,
                0.19856086373329163,
                -0.20750950276851654,
                0.1934720277786255,
                0.1695334017276764,
                0.35057705640792847,
                0.8164747357368469,
                -0.5260503888130188,
                0.4701869487762451,
                -0.0847930833697319,
                1.0059252977371216,
                -0.1531749665737152,
                0.5798980593681335,
                0.5118061304092407,
                -0.08877452462911606,
                0.5361617207527161,
                -0.19828122854232788,
                -0.626727819442749,
                0.0027687400579452515,
                0.16366590559482574,
                -0.2354445904493332,
                -0.3418353497982025,
                -0.12774857878684998,
                -0.2635509967803955,
                -0.17751312255859375,
                0.4779490530490875,
                -0.1753741353750229,
                0.16153106093406677,
                0.08859550207853317,
                0.5089671611785889,
                0.06932155787944794,
                -0.09101227670907974,
                -0.028528248891234398,
                -0.2254699170589447,
                -0.6483758687973022,
                0.25076037645339966,
                0.10813120752573013,
                -0.47953179478645325,
                0.06824367493391037,
                0.2288055121898651,
                0.1790720522403717,
                0.09369050711393356,
                -0.46352335810661316,
                0.19133225083351135,
                -0.11277837306261063,
                -0.08373592793941498,
                0.2241983413696289,
                0.49396249651908875,
                -0.12712430953979492,
                0.4022749364376068,
                -0.3742312788963318,
                -0.4328862726688385,
                0.4760826528072357,
                -0.29553428292274475,
                0.2108263224363327,
                -0.1769857555627823,
                -0.6542826294898987,
                -0.038073569536209106,
                0.03969839960336685,
                -0.824622392654419,
                -0.2069089114665985,
                0.7911543846130371,
                -0.31304931640625,
                0.29881957173347473,
                -0.30139341950416565,
                -0.21542687714099884,
                -0.23787204921245575,
                0.9726185202598572,
                -0.11405715346336365,
                -0.20732127130031586,
                0.0748772844672203,
                -0.18044118583202362,
                -0.746006429195404,
                -0.08423052728176117,
                -0.01690611056983471,
                0.08452723920345306,
                0.07873892784118652,
                -0.6961208581924438,
                0.4686153829097748,
                0.7015410661697388,
                -0.23251664638519287,
                0.1069047600030899,
                0.04657469317317009,
                0.20787957310676575,
                0.20488816499710083,
                -0.33509597182273865,
                1.3603311777114868,
                0.2944624125957489,
                0.11969885230064392,
                -0.15081171691417694,
                0.1229020431637764,
                0.9375982880592346,
                -0.0888463631272316,
                -0.2416304498910904,
                -0.3882911801338196,
                1.0227378606796265,
                -0.3252086937427521,
                0.1559360772371292,
                -0.09149619936943054,
                0.8781847953796387,
                -0.4264323115348816,
                0.1511499434709549,
                0.4514108896255493,
                0.44267991185188293,
                0.21956734359264374,
                -0.20412969589233398,
                -0.16863279044628143,
                -0.3951651453971863,
                -0.26397860050201416,
                -1.531206488609314,
                0.5362508296966553,
                -0.09515263140201569,
                -0.39017564058303833,
                -0.13496990501880646,
                0.3227900266647339,
                0.3607678711414337,
                -0.11019506305456161,
                0.8424713015556335,
                -0.06484213471412659,
                -0.4745679199695587,
                0.28153419494628906,
                -0.24959087371826172,
                0.2264888882637024,
                -0.6804726123809814,
                0.28770411014556885,
                0.25419339537620544,
                -0.2595692574977875,
                0.2794118821620941,
                -0.13899606466293335,
                0.0984094962477684,
                -0.6448785662651062,
                0.3233892619609833,
                -0.2920567989349365,
                0.0037150017451494932,
                0.2946854531764984,
                -0.17420198023319244,
                -0.17724137008190155,
                0.3526952266693115,
                -0.14402833580970764,
                0.16683520376682281,
                -0.23971429467201233,
                0.34323063492774963,
                -0.133588507771492,
                -0.10678951442241669,
                -0.9364210367202759,
                -0.4413934051990509,
                0.18632201850414276,
                0.913229763507843,
                0.14927823841571808,
                -0.08116357028484344,
                -0.4661025404930115,
                0.2521301209926605,
                -0.02614154852926731,
                0.25917619466781616,
                0.3791075646877289,
                0.07145041972398758,
                -0.7938507795333862,
                -0.21881239116191864,
                -0.32950761914253235,
                -0.4006103575229645,
                0.6405806541442871,
                0.16435079276561737,
                -0.2937681972980499,
                -0.1606595367193222,
                0.3404197692871094,
                -0.45410895347595215,
                -1.3787387609481812,
                -0.5491214990615845,
                -0.6773049831390381,
                -0.06157960370182991,
                -0.347721666097641,
                0.009365266188979149,
                0.19263456761837006,
                -0.3474105894565582,
                -0.1927655190229416,
                -0.6139588952064514,
                -0.44361430406570435,
                -0.09511952102184296,
                0.3303891718387604,
                -0.48668941855430603,
                0.15419630706310272,
                -0.20294511318206787,
                0.4041832983493805,
                0.2118920534849167,
                0.5955860018730164,
                0.3767453134059906,
                0.22132693231105804,
                -0.17279258370399475,
                0.3139749765396118,
                0.2044854313135147,
                -0.07875070720911026,
                0.7232677340507507,
                0.1583298146724701,
                -0.5373799204826355,
                0.2580733895301819,
                0.8794475197792053,
                0.7041189074516296,
                -0.029609940946102142,
                -0.9069226980209351,
                -0.12561260163784027,
                0.04992552846670151,
                -0.05187287554144859,
                -0.14715993404388428,
                -0.2676817774772644,
                -0.7144167423248291,
                0.746989905834198,
                0.027960296720266342,
                -0.2345058023929596,
                -0.24530310928821564,
                -0.4418846070766449,
                0.20588812232017517,
                0.10100400447845459,
                0.5053861141204834,
                -0.9715483784675598,
                -0.556318461894989,
                -1.3192253112792969,
                -0.06484077125787735,
                -0.23958221077919006,
                0.7251783013343811,
                -0.04013122618198395,
                -0.7128359079360962,
                -1.0982697010040283,
                0.5980737805366516,
                0.02031039260327816,
                0.6903632879257202,
                0.687804102897644,
                -0.5016148090362549,
                -1.0357238054275513,
                -0.1542840451002121,
                -0.620069682598114,
                -0.5875584483146667,
                0.5277600884437561,
                0.3373229503631592,
                -0.10938777774572372,
                -0.13037686049938202,
                0.17920894920825958,
                -0.32208120822906494,
                0.03153534233570099,
                0.06065673753619194,
                0.11981542408466339,
                -0.320109486579895,
                0.5327385067939758,
                -0.08335783332586288,
                -0.21879251301288605,
                -0.24868087470531464,
                0.0681283101439476,
                -0.2231881022453308,
                -0.4916366636753082,
                0.271749883890152,
                0.02964933030307293,
                -0.22169546782970428,
                0.23724453151226044,
                -0.6623669266700745,
                -0.06914231181144714,
                -0.7225630879402161,
                -0.003738932777196169,
                0.5142609477043152,
                0.22305238246917725,
                0.2577921450138092,
                -0.06323813647031784,
                -0.062219273298978806,
                -0.3329606056213379,
                -0.14112608134746552,
                -0.5310764312744141,
                -0.14662858843803406,
                -0.24692164361476898,
                -0.23865900933742523,
                -0.6318734288215637,
                -0.22784185409545898,
                -0.6288549304008484,
                -0.43135854601860046,
                0.15271443128585815,
                -0.32667505741119385,
                0.6768869161605835,
                -0.8129217028617859,
                -0.05087938904762268,
                0.008144853636622429,
                0.4903939962387085,
                -0.22698138654232025,
                -0.1392965018749237,
                0.11015809327363968,
                0.7057641744613647,
                -0.11203265190124512,
                -0.40562623739242554,
                -0.7056989073753357,
                -0.49784761667251587,
                0.15654276311397552,
                0.26089438796043396,
                -0.6472944021224976,
                0.5285595059394836,
                -0.5490214228630066,
                -0.3818650543689728,
                0.10919191688299179,
                -0.08159177750349045,
                0.05992165952920914,
                0.6663971543312073,
                0.07032526284456253,
                0.19751666486263275,
                -0.7030373811721802,
                -0.28173011541366577,
                -0.04761964827775955,
                -0.044846002012491226,
                -0.19864659011363983,
                0.3481825292110443,
                -0.7094607949256897,
                -0.4777190089225769,
                0.028189634904265404,
                0.6192757487297058,
                0.42698007822036743,
                -0.5303540229797363,
                -0.42100653052330017,
                0.515028715133667,
                -0.3439978063106537,
                -0.3769075870513916,
                0.006440925877541304,
                -0.26246753334999084,
                -0.2834961712360382,
                0.0034449193626642227,
                0.38357871770858765,
                -0.13903316855430603,
                -0.26271799206733704,
                0.12041819840669632,
                0.2278156280517578,
                -0.05428104102611542,
                0.5017540454864502,
                0.23581545054912567,
                0.6310804486274719,
                -0.6565818786621094,
                0.014383050613105297,
                -0.07984773814678192,
                1.2366894483566284,
                -0.5174907445907593,
                -0.0426168292760849,
                -0.05740085244178772,
                -0.3169480860233307,
                0.4700584411621094,
                -0.39170193672180176,
                0.6594405770301819,
                0.02798948809504509,
                0.40497568249702454,
                -0.18061289191246033,
                0.5637927055358887,
                0.044003650546073914,
                -0.3585222661495209,
                -0.20036138594150543,
                -0.9459455609321594,
                -0.06603651493787766,
                0.8360596299171448,
                0.04092930629849434,
                -0.6385685205459595,
                -0.8987953066825867,
                -0.12870073318481445,
                0.3337441384792328,
                0.1222657635807991,
                -0.3488662838935852,
                0.7074560523033142,
                0.48383626341819763,
                0.969375729560852,
                0.3513980507850647,
                -0.7267716526985168,
                -0.30809471011161804,
                -0.6316196918487549,
                -0.09689951688051224,
                -0.16571636497974396,
                0.1282704770565033,
                -0.2300737053155899,
                0.562528133392334,
                -0.06917431205511093,
                0.902400553226471,
                -0.07983241230249405,
                -0.168593168258667,
                -0.17483095824718475,
                -0.776018500328064,
                0.1459435224533081,
                -0.4472198486328125,
                -0.5216196179389954,
                -0.34554609656333923,
                0.2768550217151642,
                -0.1075562834739685,
                0.3789951503276825,
                0.20993691682815552,
                -0.5531315803527832,
                -0.8870453834533691,
                -0.3093719482421875,
                0.14559195935726166,
                0.20073553919792175,
                0.47054144740104675,
                0.7898301482200623,
                -0.04578355327248573,
                0.2026139348745346,
                0.6194151639938354,
                -0.10449058562517166,
                0.19880814850330353,
                -0.21529799699783325,
                0.16385148465633392,
                0.7705671191215515,
                -0.1279304325580597,
                0.3208827078342438,
                -0.38349175453186035,
                -0.31135329604148865,
                0.5427461266517639,
                0.017484892159700394,
                -0.1319989114999771,
                0.1858629733324051,
                0.5915332436561584,
                0.34752288460731506,
                -0.6131061911582947,
                0.324531614780426,
                -0.11702188849449158,
                -1.1242281198501587,
                -0.08540552109479904,
                0.11970769613981247,
                -0.22115656733512878,
                0.10165628790855408,
                -0.3490418493747711,
                -0.9891452789306641,
                -0.030316907912492752,
                0.3450878858566284,
                0.2997520864009857,
                0.17024089395999908,
                -0.6413496136665344,
                -0.3992002308368683,
                -0.8145883083343506,
                -0.058119066059589386,
                1.0097287893295288,
                -0.010225396603345871,
                -0.30298057198524475,
                -0.41732892394065857,
                0.23825491964817047,
                0.24237100780010223,
                -0.6451799869537354,
                0.3729553818702698,
                -0.31466352939605713,
                0.07791527360677719,
                0.3156801462173462,
                -0.28641772270202637,
                0.04391622543334961,
                -0.09330517798662186,
                -0.24778619408607483,
                0.6437869668006897,
                0.16294626891613007,
                -0.027654731646180153,
                0.042098239064216614,
                -0.4923708140850067,
                -0.16272874176502228,
                -0.6063188910484314,
                0.21497124433517456,
                0.0070242672227323055,
                0.04799569770693779,
                0.3299310505390167,
                -0.42179495096206665,
                0.5751703381538391,
                0.016256432980298996,
                -0.18115723133087158,
                0.29004207253456116,
                -0.17944009602069855,
                -0.8155977129936218,
                0.9906038045883179,
                -0.0684276893734932,
                0.16491639614105225,
                0.039771392941474915,
                -0.09992160648107529,
                -0.24342893064022064,
                0.368577241897583,
                -0.28124356269836426,
                0.12004987895488739,
                -0.29978346824645996,
                1.041008710861206,
                0.5557337403297424,
                0.3693493604660034,
                0.5188021659851074,
                0.15601375699043274,
                0.5379528999328613,
                -0.19945023953914642,
                -0.2902695834636688,
                -0.8002118468284607,
                -0.18319475650787354,
                0.4795738160610199,
                0.15912456810474396,
                -0.8390167951583862,
                0.03588936850428581,
                0.7073655128479004,
                -0.2846694886684418,
                0.42131292819976807,
                0.5069639086723328,
                -0.664389967918396,
                0.04771018028259277,
                -0.40846529603004456,
                0.03486019745469093,
                -0.11565572023391724,
                0.6901571154594421,
                -0.05872642248868942,
                -0.6754209399223328,
                -0.7400169968605042,
                0.5156122446060181,
                -0.6339589953422546,
                0.006395762320607901,
                -0.5476705431938171,
                -0.2446639984846115,
                0.0954650267958641,
                0.45324596762657166,
                0.1220875009894371,
                -0.4175843894481659,
                0.14296486973762512,
                -0.3766269087791443,
                0.5287095308303833,
                0.7835451364517212,
                -0.026928327977657318,
                -0.5936404466629028,
                -0.7941449880599976,
                -0.18296818435192108,
                -0.4079446494579315,
                0.279531329870224,
                0.14480173587799072,
                -0.5387870669364929,
                0.2440507858991623,
                0.23252160847187042,
                -0.14901867508888245,
                0.2757190465927124,
                -0.3900783061981201,
                -0.4148840606212616,
                -0.25560635328292847,
                0.1141568198800087,
                0.2618352472782135,
                -0.42978549003601074,
                -0.27062591910362244,
                0.06315115839242935,
                -0.11942434310913086,
                0.9098410606384277,
                -0.039751142263412476,
                0.14727918803691864,
                0.18801987171173096,
                0.3251587748527527,
                -0.045475833117961884,
                -0.25201481580734253,
                0.01690402440726757,
                0.16424313187599182,
                -0.299111008644104,
                -0.22151966392993927,
                0.16885864734649658,
                -0.2206590622663498,
                0.08141818642616272,
                -0.6072942614555359,
                -0.39326155185699463,
                -0.31924840807914734,
                -0.3898164629936218,
                -0.680820107460022,
                0.6601096391677856,
                -0.22094976902008057,
                0.5930375456809998,
                -0.9316952228546143,
                0.3981449007987976,
                -0.771848201751709,
                -0.29343897104263306,
                -0.6037405729293823,
                -0.38049471378326416,
                0.026748010888695717,
                0.20409297943115234,
                0.3270692229270935,
                -0.285354346036911,
                0.6800437569618225,
                2.3593313694000244,
                -0.5345933437347412,
                0.5892215371131897,
                0.3509598672389984,
                -0.06715694069862366,
                0.3798431158065796,
                0.2276558130979538,
                -0.10457077622413635,
                -0.5160767436027527,
                -0.2119223177433014,
                0.5202040076255798,
                -0.18882860243320465,
                0.2787666916847229,
                0.37585732340812683,
                -0.429981529712677,
                0.060315657407045364,
                0.6582309603691101,
                0.5162022709846497,
                -0.4015415906906128,
                0.5316419005393982,
                0.2644332945346832,
                0.21693915128707886,
                -0.34040823578834534,
                0.06359286606311798,
                -0.10069590061903,
                0.48655515909194946,
                0.6758853793144226,
                -0.10275652259588242,
                -0.26626938581466675,
                -0.747705340385437,
                -0.48237133026123047,
                -0.3231721520423889,
                -0.5808208584785461,
                0.32133206725120544,
                -0.11237307637929916,
                0.290559321641922,
                0.15942679345607758,
                -0.22782953083515167,
                -0.4494866728782654,
                0.6628543734550476,
                -0.08053474873304367,
                -0.5974867939949036,
                -0.3466947078704834,
                0.768276035785675,
                -0.21915662288665771,
                -0.5059670805931091,
                -1.1688247919082642,
                0.08051365613937378,
                -0.015255832113325596,
                0.3579619526863098,
                0.5065681338310242,
                0.5194821953773499,
                -0.5033830404281616,
                -0.05194907262921333,
                0.18014751374721527,
                0.23547136783599854,
                -0.09561579674482346,
                0.2606763243675232,
                -0.18933320045471191,
                -0.10133592039346695,
                0.7249830365180969,
                -0.47571462392807007,
                -0.9250385165214539,
                -0.19087901711463928,
                0.39210930466651917,
                0.19350656867027283,
                0.16022035479545593,
                0.027749964967370033,
                -0.149298295378685,
                -0.28131774067878723,
                -0.38532504439353943,
                0.36906126141548157,
                0.034329939633607864
        };
        float[] floatArray = new float[vectors.length];
        for (int i = 0; i < vectors.length; i++) {
            floatArray[i] = (float) vectors[i];
        }
        embeddingStore.add(Embedding.from(floatArray));
    }
}
